â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ BODY                                                                                                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ /**                                                                                                   â”‚
â”‚ * Klasa do integracji z OpenAI API z uÅ¼yciem Named Credential i Custom Setting.                       â”‚
â”‚ */                                                                                                    â”‚
â”‚ public with sharing class OpenAIService {                                                             â”‚
â”‚ // DeveloperName Named Credential (z Setup)                                                           â”‚
â”‚ private static final String NAMED_CREDENTIAL = 'AI_CV_Analysis_API';                                  â”‚
â”‚ // ÅšcieÅ¼ka do endpointu OpenAI                                                                        â”‚
â”‚ private static final String ENDPOINT_PATH = '/v1/chat/completions';                                   â”‚
â”‚ // Maksymalna liczba tokenÃ³w w zapytaniu                                                              â”‚
â”‚ private static final Integer MAX_TOKENS = 4000;                                                       â”‚
â”‚                                                                                                       â”‚
â”‚ /**                                                                                                   â”‚
â”‚ * WysyÅ‚a zapytanie do OpenAI (model GPT) i zwraca odpowiedÅº w postaci String.                         â”‚
â”‚ * @param prompt - TreÅ›Ä‡ pytania od uÅ¼ytkownika                                                        â”‚
â”‚ * @param systemPrompt - Dodatkowy kontekst (roli systemu)                                             â”‚
â”‚ * @return OdpowiedÅº modelu OpenAI                                                                     â”‚
â”‚ */                                                                                                    â”‚
â”‚ public static String callOpenAI(String prompt, String systemPrompt) {                                 â”‚
â”‚ try {                                                                                                 â”‚
â”‚ // SprawdÅº uprawnienia                                                                                â”‚
â”‚ validateOpenAISettingsAccess();                                                                       â”‚
â”‚                                                                                                       â”‚
â”‚ // 1. Pobranie klucza API z Custom Setting (Hierarchy)                                                â”‚
â”‚ OpenAI_Settings__c setting = OpenAI_Settings__c.getInstance();                                        â”‚
â”‚ if (setting == null || String.isBlank(setting.API_Key__c)) {                                          â”‚
â”‚ throw new OpenAIException('Brak skonfigurowanego klucza API w OpenAI_Settings__c (pole API_Key__c).');â”‚
â”‚ }                                                                                                     â”‚
â”‚                                                                                                       â”‚
â”‚ // 2. Przygotowanie ciaÅ‚a zapytania (zgodnie z dokumentacjÄ… OpenAI)                                   â”‚
â”‚ Map<String, Object> requestBody = new Map<String, Object>{                                            â”‚
â”‚ 'model' => 'gpt-3.5-turbo', // lub gpt-4, jeÅ›li masz dostÄ™p                                           â”‚
â”‚ 'messages' => new List<Object>{                                                                       â”‚
â”‚ new Map<String, String>{                                                                              â”‚
â”‚ 'role' => 'system',                                                                                   â”‚
â”‚ 'content' => systemPrompt                                                                             â”‚
â”‚ },                                                                                                    â”‚
â”‚ new Map<String, String>{                                                                              â”‚
â”‚ 'role' => 'user',                                                                                     â”‚
â”‚ 'content' => prompt                                                                                   â”‚
â”‚ }                                                                                                     â”‚
â”‚ },                                                                                                    â”‚
â”‚ 'max_tokens' => MAX_TOKENS,                                                                           â”‚
â”‚ 'temperature' => 0.5                                                                                  â”‚
â”‚ };                                                                                                    â”‚
â”‚                                                                                                       â”‚
â”‚ // 3. Tworzymy obiekt HttpRequest                                                                     â”‚
â”‚ HttpRequest req = new HttpRequest();                                                                  â”‚
â”‚ // UÅ¼ywamy Named Credential + Å›cieÅ¼kÄ™ endpointu                                                       â”‚
â”‚ req.setEndpoint('callout:' + NAMED_CREDENTIAL + ENDPOINT_PATH);                                       â”‚
â”‚ req.setMethod('POST');                                                                                â”‚
â”‚ req.setHeader('Content-Type', 'application/json');                                                    â”‚
â”‚ // DokÅ‚adamy nagÅ‚Ã³wek Authorization z kluczem pobranym z Custom Setting                               â”‚
â”‚ req.setHeader('Authorization', 'Bearer ' + setting.API_Key__c);                                       â”‚
â”‚ req.setBody(JSON.serialize(requestBody));                                                             â”‚
â”‚ req.setTimeout(120000); // 2 minuty (120s) na callout                                                 â”‚
â”‚                                                                                                       â”‚
â”‚ // 4. (Opcjonalnie) sprawdzenie limitÃ³w callout                                                       â”‚
â”‚ checkGovernorLimits('CALLOUT');                                                                       â”‚
â”‚                                                                                                       â”‚
â”‚ // 5. WysyÅ‚amy zapytanie                                                                              â”‚
â”‚ Http http = new Http();                                                                               â”‚
â”‚ HttpResponse res = http.send(req);                                                                    â”‚
â”‚                                                                                                       â”‚
â”‚ // 6. ObsÅ‚uga odpowiedzi                                                                              â”‚
â”‚ if (res.getStatusCode() == 200) {                                                                     â”‚
â”‚ // Parsujemy JSON                                                                                     â”‚
â”‚ Map<String, Object> responseMap = (Map<String, Object>) JSON.deserializeUntyped(res.getBody());       â”‚
â”‚ List<Object> choices = (List<Object>) responseMap.get('choices');                                     â”‚
â”‚ if (choices != null && !choices.isEmpty()) {                                                          â”‚
â”‚ Map<String, Object> choice = (Map<String, Object>) choices[0];                                        â”‚
â”‚ Map<String, Object> message = (Map<String, Object>) choice.get('message');                            â”‚
â”‚ if (message != null) {                                                                                â”‚
â”‚ return (String) message.get('content');                                                               â”‚
â”‚ }                                                                                                     â”‚
â”‚ }                                                                                                     â”‚
â”‚ throw new OpenAIException('NieprawidÅ‚owa struktura odpowiedzi z OpenAI (brak "message.content").');   â”‚
â”‚ } else {                                                                                              â”‚
â”‚ // Logowanie bÅ‚Ä™du                                                                                    â”‚
â”‚ System.debug(LoggingLevel.ERROR,                                                                      â”‚
â”‚ 'OpenAIService.callOpenAI: BÅ‚Ä…d OpenAI API: ' +                                                       â”‚
â”‚ res.getStatusCode() + ' - ' + res.getBody()                                                           â”‚
â”‚ );                                                                                                    â”‚
â”‚ // ObsÅ‚uga typowych kodÃ³w bÅ‚Ä™dÃ³w                                                                      â”‚
â”‚ if (res.getStatusCode() == 429) {                                                                     â”‚
â”‚ throw new OpenAIException('Przekroczono limit zapytaÅ„ do OpenAI. SprÃ³buj ponownie pÃ³Åºniej.');         â”‚
â”‚ } else if (res.getStatusCode() == 401) {                                                              â”‚
â”‚ throw new OpenAIException('NieprawidÅ‚owy lub wygasÅ‚y klucz API OpenAI.');                             â”‚
â”‚ } else {                                                                                              â”‚
â”‚ throw new OpenAIException('BÅ‚Ä…d podczas wywoÅ‚ywania OpenAI API: ' + res.getStatusCode());             â”‚
â”‚ }                                                                                                     â”‚
â”‚ }                                                                                                     â”‚
â”‚ } catch (System.CalloutException e) {                                                                 â”‚
â”‚ System.debug(LoggingLevel.ERROR,                                                                      â”‚
â”‚ 'OpenAIService.callOpenAI: WyjÄ…tek podczas wywoÅ‚ywania OpenAI API: ' + e.getMessage()                 â”‚
â”‚ );                                                                                                    â”‚
â”‚ throw new OpenAIException('Nie moÅ¼na poÅ‚Ä…czyÄ‡ siÄ™ z OpenAI API: ' + e.getMessage());                  â”‚
â”‚ }                                                                                                     â”‚
â”‚ }                                                                                                     â”‚
â”‚                                                                                                       â”‚
â”‚ /**                                                                                                   â”‚
â”‚ * (Opcjonalne) Sprawdzenie limitÃ³w wywoÅ‚aÅ„ zewnÄ™trznych (calloutÃ³w)                                   â”‚
â”‚ */                                                                                                    â”‚
â”‚ private static void checkGovernorLimits(String operationType) {                                       â”‚
â”‚ if (operationType == 'CALLOUT') {                                                                     â”‚
â”‚ if (Limits.getCallouts() >= Limits.getLimitCallouts()) {                                              â”‚
â”‚ throw new OpenAIException('OsiÄ…gniÄ™to maksymalny limit calloutÃ³w. SprÃ³buj ponownie pÃ³Åºniej.');        â”‚
â”‚ }                                                                                                     â”‚
â”‚ }                                                                                                     â”‚
â”‚ }                                                                                                     â”‚
â”‚                                                                                                       â”‚
â”‚ /**                                                                                                   â”‚
â”‚ * Sprawdza uprawnienia dostÄ™pu do ustawieÅ„ OpenAI                                                     â”‚
â”‚ */                                                                                                    â”‚
â”‚ private static void validateOpenAISettingsAccess() {                                                  â”‚
â”‚ try {                                                                                                 â”‚
â”‚ SecurityUtils.checkReadAccess(OpenAI_Settings__c.SObjectType,                                         â”‚
â”‚ new List<String>{'API_Key__c'});                                                                      â”‚
â”‚ } catch (SecurityUtils.SecurityException e) {                                                         â”‚
â”‚ throw new SecurityException('Insufficient permissions to access OpenAI settings: ' + e.getMessage()); â”‚
â”‚ }                                                                                                     â”‚
â”‚ }                                                                                                     â”‚
â”‚                                                                                                       â”‚
â”‚ /**                                                                                                   â”‚
â”‚ * Niestandardowy wyjÄ…tek dla bÅ‚Ä™dÃ³w OpenAI                                                            â”‚
â”‚ */                                                                                                    â”‚
â”‚ public class OpenAIException extends Exception {}                                                     â”‚
â”‚ }                                                                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

[1mTotal number of records retrieved: 1.[22m
